
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detector de Malaria</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
        h1 { font-size: 2.5em; }
        #webcam { margin: 20px auto; display: block; }
        #resultado { font-size: 2em; font-weight: bold; margin-top: 20px; }
        #cambiarCamara { padding: 10px 20px; font-size: 1em; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Detector de Malaria</h1>
    <p>Clasificación de Malaria (infectado o no infectado) usando la cámara web con TensorFlow.js</p>
    <button id="cambiarCamara">Cambiar cámara</button>
    <video id="webcam" autoplay playsinline width="300" height="300"></video>
    <div id="resultado">Cargando modelo...</div>

    <script>
        let modelo;
        let webcamStream;
        let useFrontCamera = true;

        async function cargarModelo() {
            const response = await fetch('model.json');
            const modelJSON = await response.json();

            // Adaptar el InputLayer para tfjs si es necesario
            modelJSON.modelTopology.config.layers[0].config.batchInputShape = [null, 100, 100, 1];

            modelo = await tf.models.modelFromJSON(modelJSON);
            console.log("Modelo cargado correctamente");
            document.getElementById("resultado").innerText = "Modelo cargado. Detectando...";
            iniciarClasificacion();
        }

        async function iniciarWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: 300, height: 300,
                    facingMode: useFrontCamera ? "user" : "environment"
                }
            };
            webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById("webcam");
            video.srcObject = webcamStream;
        }

        document.getElementById("cambiarCamara").onclick = () => {
            useFrontCamera = !useFrontCamera;
            iniciarWebcam();
        };

        async function iniciarClasificacion() {
            const video = document.getElementById("webcam");
            await iniciarWebcam();

            setInterval(() => {
                tf.tidy(() => {
                    const tensor = tf.browser.fromPixels(video)
                        .resizeNearestNeighbor([100, 100])
                        .mean(2)
                        .expandDims(2)
                        .expandDims()
                        .div(255.0);
                    
                    const prediccion = modelo.predict(tensor);
                    prediccion.data().then(data => {
                        const resultado = data[0] > 0.5 ? "Infectado" : "No infectado";
                        document.getElementById("resultado").innerText = resultado;
                    });
                });
            }, 1000);
        }

        cargarModelo();
    </script>
</body>
</html>
